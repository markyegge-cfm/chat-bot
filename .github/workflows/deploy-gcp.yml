name: Deploy RAG Backend to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_ID: "your-client-gcp-project"
  REGION: "us-central1"
  SERVICE_NAME: "cashflow-rag-backend"
  ENVIRONMENT: "production"

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://your-service-url.run.app
    permissions:
      contents: read
      id-token: write

    steps:
      # 1️.Checkout code
      - uses: actions/checkout@v4

      # 2️. Set up Node
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3️. Cache npm dependencies
      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # 4️. Install dependencies
      - name: Install npm dependencies
        run: npm ci

      # 5️. Authenticate to GCP
      - id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SA_EMAIL }}
          create_credentials_file: true
          export_environment_variables: true

      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      # 6️. Verify Artifact Registry exists
      - name: Verify Artifact Registry
        run: |
          gcloud artifacts repositories describe codebase-repo --location=${{ env.REGION }} >/dev/null 2>&1 || {
            echo "Artifact Registry repo 'codebase-repo' not found in ${{ env.REGION }}."
            echo "Create it once with:"
            echo "gcloud --project=${{ env.PROJECT_ID }} artifacts repositories create codebase-repo --repository-format=docker --location=${{ env.REGION }}"
            exit 1
          }

      # 7️. Set up Docker Buildx
      - uses: docker/setup-buildx-action@v3

      # 8️. Build & push Docker image to Artifact Registry
      - name: Build & push container image
        id: build
        run: |
          IMAGE="us-central1-docker.pkg.dev/${{ env.PROJECT_ID }}/codebase-repo/${{ env.SERVICE_NAME }}:${{ github.sha }}"
          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          gcloud auth configure-docker us-central1-docker.pkg.dev --quiet
          docker buildx build \
            --platform linux/amd64 \
            --tag "$IMAGE" \
            --push \
            .

      # 9️. Deploy to Cloud Run
      - name: Deploy Cloud Run service
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image "${{ steps.build.outputs.image }}" \
            --platform managed \
            --region ${{ env.REGION }} \
            --allow-unauthenticated \
            --service-account ${{ secrets.GCP_SA_EMAIL }} \
            --quiet

      # 1️0️. Output Cloud Run URL
      - name: Cloud Run URL
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region=${{ env.REGION }} --format="value(status.url)")
          echo "Your backend is live at: $SERVICE_URL"
